- name: Install nfs yum packages
  yum: name={{ item }} state=present
  with_items:
      - rpcbind
      - nfs-utils
      - policycoreutils-python
  tags:
    - metrics

- name: Create nfs export directory
  file:
    path: /srv/metrics
    group: nfsnobody
    owner: nfsnobody
    state: directory
    mode: 0777
  tags:
    - metrics

- name: Enable writing to NFS volumes with SELinux enforcing on each node
  command: "{{ item }}"
  with_items:
    - /sbin/setsebool -P virt_use_nfs 1
    - /sbin/setsebool -P virt_sandbox_use_nfs 1
  tags:
  - metrics

# Configure firewall to allow traffic to the NFS mount point.

- name: Allow default NFSv4 port (2049)
  iptables:
    chain: INPUT
    protocol: tcp
    destination_port: 2049
    jump: ACCEPT
  tags:
    - metrics

- name: Allow default NFSv4 port (2049)
  iptables:
    chain: INPUT
    protocol: tcp
    destination_port: 2049
    jump: ACCEPT
  tags:
  - metrics

- name: Allow default NFSv4 port (20049)
  iptables:
    chain: INPUT
    protocol: tcp
    destination_port: 20049
    jump: ACCEPT
  tags:
  - metrics

- name: Allow default NFSv4 port (111)
  iptables:
    chain: INPUT
    protocol: tcp
    destination_port: 111
    jump: ACCEPT
  tags:
  - metrics

- name: Save iptables rules
  command: /sbin/service iptables save
  tags:
  - metrics

- name: Start nfs-server service
  command: systemctl start nfs-server
  tags:
  - metrics

- name: Enable nfs-server service on boot
  command: systemctl enable nfs-server
  tags:
  - metrics

# The '/etc/exports' file controls which file systems are exported to remote
# hosts and specifies options. Blank lines are ignored, comments can be made by
# starting a line with the hash mark (#), and long lines can be wrapped with a
# backslash (\).

- name: Create '/etc/exports' configuration file
  file:
    path: /etc/exports
    state: touch
    mode: "0644"
  tags:
  - metrics

- name: Add metrics export
  lineinfile:
    dest: /etc/exports
    state: present
    insertafter: EOF
    line: /srv/metrics *(rw,all_squash)
  tags:
  - metrics

- name: Make all changes effective (restart)
  command: /sbin/exportfs -r
  tags:
  - metrics

- name: Show available mounts (debug)
  command: /sbin/showmount -e localhost
  tags:
  - metrics
